#!/usr/bin/env bash

set -euo pipefail

remote_name="origin"

if [[ $# -gt 1 ]]; then
    echo "Usage: $(basename "$0") [main-branch]" >&2
    exit 1
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: not inside a git repository." >&2
    exit 1
fi

detect_default_branch() {
    local ref

    if ref=$(git symbolic-ref --quiet --short "refs/remotes/${remote_name}/HEAD" 2>/dev/null); then
        printf '%s\n' "${ref#"${remote_name}"/}"
        return
    fi

    for candidate in main master; do
        if git show-ref --verify --quiet "refs/heads/${candidate}" || git show-ref --verify --quiet "refs/remotes/${remote_name}/${candidate}"; then
            printf '%s\n' "$candidate"
            return
        fi
    done

    echo "Error: unable to detect default branch. Pass it explicitly." >&2
    exit 1
}

main_branch="${1:-$(detect_default_branch)}"

if git remote get-url "$remote_name" >/dev/null 2>&1; then
    git fetch --prune "$remote_name" >/dev/null 2>&1 || echo "Warning: failed to fetch '$remote_name'; using local refs." >&2
fi

if git show-ref --verify --quiet "refs/remotes/${remote_name}/${main_branch}"; then
    base_ref="${remote_name}/${main_branch}"
else
    base_ref="$main_branch"
fi

if ! git rev-parse --verify --quiet "${base_ref}^{commit}" >/dev/null; then
    echo "Error: branch '${base_ref}' not found." >&2
    exit 1
fi

current_branch="$(git branch --show-current)"

while IFS= read -r branch; do
    [[ -z "$branch" ]] && continue
    [[ "$branch" == "$main_branch" ]] && continue
    [[ "$branch" == "$current_branch" ]] && continue

    delete_mode=""
    delete_reason=""

    if git merge-base --is-ancestor "$branch" "$base_ref"; then
        delete_mode="-d"
        delete_reason="merged"
    else
        merge_base="$(git merge-base "$base_ref" "$branch")"
        synthetic_commit="$(git commit-tree "$(git rev-parse "${branch}^{tree}")" -p "$merge_base" -m "_")"

        if [[ "$(git cherry "$base_ref" "$synthetic_commit")" == "-"* ]]; then
            delete_mode="-D"
            delete_reason="squash-merged"
        fi
    fi

    [[ -z "$delete_mode" ]] && continue

    if [[ ! -r /dev/tty ]]; then
        echo "No interactive terminal available; skipping '$branch'."
        continue
    fi

    read -r -p "Delete local branch '$branch' (${delete_reason} into ${base_ref})? [y/N] " yn </dev/tty

    case $yn in
        [yY]|[yY][eE][sS])
            git branch "$delete_mode" "$branch"
            ;;
        *)
            echo "Skipping branch '$branch'."
            ;;
    esac
done < <(git for-each-ref refs/heads/ --format='%(refname:short)')
