#!/usr/bin/env bash

# shellcheck disable=SC2034,SC2296

# utils
mcd() {
  if [[ $# -eq 0 ]] ; then
    echo "usage: mcd <directory>"; return 1;
  else
    mkdir -p -- "$1" && cd -P -- "$1" || return 1;
  fi
}

wake() {
  local hosts_file="$HOME/.wakehosts"
  local wanted="${1:-}"
  local host mac

  if [[ ! -f "$hosts_file" ]]; then
    echo ".wakehosts file not found"
    return 1
  fi

  if [[ -z "$wanted" ]]; then
    echo "no host provided"
    return 1
  fi

  while IFS='=' read -r host mac; do
    [[ -z "$host" || "$host" == \#* ]] && continue

    if [[ "$host" == "$wanted" ]]; then
      wakeonlan "$mac"
      return $?
    fi
  done < "$hosts_file"

  echo "unknown host"
  return 1
}

wx() {
  case $1 in
    py | python)
      find . -maxdepth 10 -type f -name "*.py" | entr -cp python3 /_
    ;;
    sh | bash)
      find . -maxdepth 10 -type f -name "*.sh" | entr -cp bash /_
    ;;
    js | node)
      find . -maxdepth 10 -type f -name "*.js" | entr -cp node /_
    ;;
    rb | ruby)
      find . -maxdepth 10 -type f -name "*.rb" | entr -ccp ruby -rdebug /_
    ;;
    cr | crystal)
      find . -maxdepth 10 -type f -name "*.cr" | entr -c crystal run /_
    ;;
    go)
      find . -maxdepth 10 -type f -name "*.go" | entr -c go run /_
    ;;
    spec | specs)
      find . -maxdepth 10 -type f -name "*_spec.rb" | entr -cc bundle exec rspec /_
    ;;
    zig)
      find . -maxdepth 10 -type f -name "*.zig" | entr -ccnp zig run /_
    ;;
  esac
}

until_fail () {
  "$@"
  local exit_status="$?"
  while [ $exit_status -eq "0" ]
  do
    "$@"
    exit_status="$?"
  done
}

wt() {
  case "${1:-}" in
    add)
      shift
      local path
      path="$(git wt add "$@")" || return
      cd "$path" || return
      ;;
    setup)
      if command -v bundle >/dev/null 2>&1; then
        bundle check || bundle install
      fi

      if command -v pnpm >/dev/null 2>&1; then
        pnpm install
      fi
      ;;
    rm|ls|prune)
      git wt "$@"
      ;;
    *)
      echo "usage: wt {add|rm|ls|prune|setup}"
      return 1
      ;;
  esac
}
